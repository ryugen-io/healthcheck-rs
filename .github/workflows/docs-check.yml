name: Docs Validation

on:
  push:
    branches: [ master, main ]
    paths:
      - '**.md'
  pull_request:
    branches: [ master, main ]
    paths:
      - '**.md'

jobs:
  check-readme-release:
    name: Verify README release hash
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for tags

      - name: Get latest release tag hash
        id: release
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LATEST_TAG" ]; then
            echo "No release tags found yet - skipping validation"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get the commit hash of that tag
          RELEASE_HASH=$(git rev-parse --short "$LATEST_TAG")
          echo "Latest release: $LATEST_TAG ($RELEASE_HASH)"
          echo "hash=$RELEASE_HASH" >> $GITHUB_OUTPUT
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Check README badges
        if: steps.release.outputs.skip != 'true'
        run: |
          RELEASE_HASH="${{ steps.release.outputs.hash }}"
          RELEASE_TAG="${{ steps.release.outputs.tag }}"

          echo "Checking README badges..."
          echo "Latest release: $RELEASE_TAG ($RELEASE_HASH)"
          echo ""

          ERRORS=0

          # Check 1: Release badge exists
          if grep -q "shields.io/github/v/release/ryugen-io/healthcheck-rs" README.md; then
            echo "✓ Release badge present"
          else
            echo "✗ Release badge missing!"
            echo "  Add: [![Release](https://img.shields.io/github/v/release/ryugen-io/healthcheck-rs?logo=github)](https://github.com/ryugen-io/healthcheck-rs/releases)"
            ERRORS=$((ERRORS + 1))
          fi

          # Check 2: Commit badge has correct hash
          if grep -q "shields.io/badge/commit-$RELEASE_HASH-" README.md; then
            echo "✓ Commit badge has latest release hash: $RELEASE_HASH"
          else
            echo "✗ Commit badge does not have latest release hash!"
            echo "  Expected hash: $RELEASE_HASH"
            echo "  Update: ![Last Commit](https://img.shields.io/badge/commit-$RELEASE_HASH-blue?logo=git)"
            ERRORS=$((ERRORS + 1))
          fi

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "✗ ZONK! $ERRORS badge error(s) found"
            exit 1
          else
            echo ""
            echo "✓ All badges valid"
          fi
