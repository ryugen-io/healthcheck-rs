name: Docs Validation

on:
  push:
    branches: [ master, main ]
    paths:
      - '**.md'
  pull_request:
    branches: [ master, main ]
    paths:
      - '**.md'

jobs:
  check-readme-commit:
    name: Verify README commit reference
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need current and previous commit

      - name: Get current commit hash
        id: current
        run: echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Get previous commit hash
        id: previous
        run: echo "hash=$(git rev-parse --short HEAD^)" >> $GITHUB_OUTPUT

      - name: Check if README shield contains current or previous commit
        run: |
          CURRENT_HASH="${{ steps.current.outputs.hash }}"
          PREVIOUS_HASH="${{ steps.previous.outputs.hash }}"

          echo "Current commit: $CURRENT_HASH"
          echo "Previous commit: $PREVIOUS_HASH"

          # Check for shield badge with commit hash
          if grep -q "shields.io/badge/commit-$CURRENT_HASH-" README.md; then
            echo "✓ README.md shield contains current commit hash: $CURRENT_HASH"
            exit 0
          elif grep -q "shields.io/badge/commit-$PREVIOUS_HASH-" README.md; then
            echo "✓ README.md shield contains previous commit hash: $PREVIOUS_HASH"
            exit 0
          else
            echo "✗ ZONK! README.md shield does not contain current ($CURRENT_HASH) or previous ($PREVIOUS_HASH) commit hash"
            echo ""
            echo "Please update the commit shield badge in README.md:"
            echo "![Last Commit](https://img.shields.io/badge/commit-$CURRENT_HASH-blue?logo=git)"
            exit 1
          fi
